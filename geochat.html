<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ProximiChat Â· Field Comms</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c0f;
    --surface: #111418;
    --surface2: #181c22;
    --border: #1e2530;
    --accent: #00e5a0;
    --accent2: #0090ff;
    --warn: #ff6b35;
    --text: #c8d4e0;
    --text-dim: #5a6a7a;
    --text-mono: #7fffcc;
    --mine-bg: #0d2a1e;
    --mine-border: #00e5a0;
    --other-bg: #111c2a;
    --other-border: #0090ff;
    --radius-ring: rgba(0,229,160,0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-weight: 400;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 10px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    position: relative;
    z-index: 10;
  }

  .logo {
    font-family: 'Share Tech Mono', monospace;
    font-size: 1.1rem;
    color: var(--accent);
    letter-spacing: 0.08em;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .logo-pulse {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0,229,160,0.5); }
    50% { opacity: 0.6; box-shadow: 0 0 0 6px rgba(0,229,160,0); }
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 0.72rem;
    font-family: 'Share Tech Mono', monospace;
    color: var(--text-dim);
  }

  .status-badge {
    display: flex; align-items: center; gap: 5px;
    padding: 3px 8px;
    border: 1px solid var(--border);
    border-radius: 3px;
    background: var(--surface2);
  }

  .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--text-dim);
  }

  .dot.ok { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
  .dot.warn { background: var(--warn); box-shadow: 0 0 6px var(--warn); }

  /* â”€â”€â”€ USER SETUP OVERLAY â”€â”€â”€ */
  #setup-overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(10,12,15,0.96);
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(6px);
  }

  .setup-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 36px 40px;
    width: min(420px, 92vw);
    box-shadow: 0 0 60px rgba(0,229,160,0.05);
  }

  .setup-card h2 {
    font-family: 'Share Tech Mono', monospace;
    color: var(--accent);
    font-size: 1rem;
    letter-spacing: 0.1em;
    margin-bottom: 6px;
  }

  .setup-card p {
    color: var(--text-dim);
    font-size: 0.82rem;
    margin-bottom: 24px;
    line-height: 1.5;
  }

  .field-label {
    font-size: 0.72rem;
    font-family: 'Share Tech Mono', monospace;
    color: var(--text-dim);
    letter-spacing: 0.08em;
    margin-bottom: 6px;
    text-transform: uppercase;
  }

  .field-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 0.95rem;
    padding: 10px 12px;
    outline: none;
    transition: border-color 0.2s;
    margin-bottom: 18px;
  }

  .field-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0,229,160,0.1);
  }

  .btn-primary {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 4px;
    padding: 12px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.9rem;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
  }

  .btn-primary:hover { opacity: 0.9; }
  .btn-primary:active { transform: scale(0.98); }
  .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; }

  .geo-status {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem;
    text-align: center;
    margin-top: 12px;
    color: var(--text-dim);
    min-height: 16px;
  }

  /* â”€â”€â”€ MAIN LAYOUT â”€â”€â”€ */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â”€â”€â”€ STATUS BAR â”€â”€â”€ */
  .status-bar {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 6px 18px;
    display: flex;
    align-items: center;
    gap: 18px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.68rem;
    color: var(--text-dim);
    flex-shrink: 0;
    overflow-x: auto;
  }

  .sb-item { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
  .sb-val { color: var(--text-mono); }

  /* â”€â”€â”€ MESSAGES â”€â”€â”€ */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 18px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scroll-behavior: smooth;
  }

  #messages::-webkit-scrollbar { width: 4px; }
  #messages::-webkit-scrollbar-track { background: transparent; }
  #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg {
    max-width: 72%;
    animation: msgIn 0.25s ease-out;
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg.mine { align-self: flex-end; }
  .msg.other { align-self: flex-start; }

  .msg-bubble {
    padding: 10px 14px;
    border-radius: 6px;
    border-left: 3px solid transparent;
    line-height: 1.5;
    font-size: 0.9rem;
    word-break: break-word;
  }

  .msg.mine .msg-bubble {
    background: var(--mine-bg);
    border-left-color: var(--mine-border);
    color: #d0f5e8;
  }

  .msg.other .msg-bubble {
    background: var(--other-bg);
    border-left-color: var(--other-border);
    color: #cde0f5;
  }

  .msg-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
  }

  .msg.mine .msg-meta { flex-direction: row-reverse; }

  .msg-user { color: var(--accent); }
  .msg.other .msg-user { color: var(--accent2); }
  .msg-time { color: var(--text-dim); }
  .msg-dist {
    color: var(--text-dim);
    font-size: 0.6rem;
    padding: 1px 5px;
    border: 1px solid var(--border);
    border-radius: 2px;
  }

  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: var(--text-dim);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    letter-spacing: 0.05em;
    opacity: 0.5;
  }

  .empty-icon {
    width: 60px; height: 60px;
    border: 1px solid var(--border);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem;
    position: relative;
  }

  .empty-icon::before, .empty-icon::after {
    content: '';
    position: absolute;
    border: 1px solid var(--border);
    border-radius: 50%;
    animation: radarRing 3s ease-out infinite;
  }

  .empty-icon::before { inset: -12px; animation-delay: 0s; }
  .empty-icon::after { inset: -24px; animation-delay: 0.8s; }

  @keyframes radarRing {
    0% { opacity: 0.6; transform: scale(1); }
    100% { opacity: 0; transform: scale(1.3); }
  }

  /* â”€â”€â”€ INPUT AREA â”€â”€â”€ */
  .input-area {
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 14px 18px;
    flex-shrink: 0;
  }

  .input-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  #msg-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    font-size: 0.92rem;
    padding: 10px 14px;
    outline: none;
    resize: none;
    min-height: 42px;
    max-height: 120px;
    transition: border-color 0.2s;
    line-height: 1.4;
  }

  #msg-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0,229,160,0.08);
  }

  #msg-input::placeholder { color: var(--text-dim); }

  #send-btn {
    background: var(--accent);
    border: none;
    border-radius: 4px;
    color: #000;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.8rem;
    padding: 10px 18px;
    cursor: pointer;
    letter-spacing: 0.06em;
    transition: opacity 0.15s, transform 0.1s;
    align-self: stretch;
    display: flex; align-items: center; gap: 6px;
    white-space: nowrap;
  }

  #send-btn:hover { opacity: 0.88; }
  #send-btn:active { transform: scale(0.97); }
  #send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .sending-spinner {
    width: 10px; height: 10px;
    border: 2px solid rgba(0,0,0,0.3);
    border-top-color: #000;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .input-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 8px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.63rem;
    color: var(--text-dim);
  }

  .scan-indicator {
    display: flex; align-items: center; gap: 5px;
  }

  .scan-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: var(--accent2);
    animation: scanPulse 2s ease-in-out infinite;
  }

  @keyframes scanPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.2; }
  }

  /* â”€â”€â”€ TOAST â”€â”€â”€ */
  #toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 16px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem;
    color: var(--text);
    opacity: 0;
    transition: all 0.2s;
    pointer-events: none;
    z-index: 50;
    white-space: nowrap;
  }

  #toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  #toast.error { border-color: var(--warn); color: var(--warn); }
  #toast.success { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€â”€ CONFIG MODAL â”€â”€â”€ */
  #config-modal {
    position: fixed; inset: 0; z-index: 80;
    background: rgba(10,12,15,0.9);
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
  }

  #config-modal.open { display: flex; }

  .config-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 28px 32px;
    width: min(460px, 92vw);
    max-height: 85vh;
    overflow-y: auto;
  }

  .config-card h3 {
    font-family: 'Share Tech Mono', monospace;
    color: var(--accent);
    font-size: 0.85rem;
    letter-spacing: 0.1em;
    margin-bottom: 20px;
  }

  .config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .config-grid .full { grid-column: 1/-1; }

  .config-row { display: flex; flex-direction: column; gap: 4px; }

  .config-row label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.62rem;
    color: var(--text-dim);
    letter-spacing: 0.06em;
  }

  .config-row input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.72rem;
    padding: 7px 10px;
    outline: none;
  }

  .config-row input:focus { border-color: var(--accent); }

  .config-actions {
    display: flex; gap: 10px; margin-top: 20px;
  }

  .btn-sm {
    flex: 1; padding: 9px;
    border-radius: 4px; border: none;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer; letter-spacing: 0.06em;
  }

  .btn-sm.primary { background: var(--accent); color: #000; }
  .btn-sm.secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }

  /* â”€â”€â”€ SETTINGS ICON â”€â”€â”€ */
  .icon-btn {
    background: none; border: none;
    color: var(--text-dim); cursor: pointer;
    padding: 4px; font-size: 1rem;
    transition: color 0.15s;
  }

  .icon-btn:hover { color: var(--text); }
</style>
</head>
<body>

<!-- SETUP OVERLAY -->
<div id="setup-overlay">
  <div class="setup-card">
    <h2>â–¸ PROXIMICHAT</h2>
    <p>Location-aware field communications. Messages visible within your 20m proximity radius.</p>

    <div class="field-label">CALL SIGN / USERNAME</div>
    <input type="text" class="field-input" id="setup-username" placeholder="Enter your call sign..." maxlength="30" />

    <button class="btn-primary" id="setup-btn" onclick="startSession()">
      ACQUIRE SIGNAL &amp; ENTER
    </button>
    <div class="geo-status" id="geo-status">Waiting for location permission...</div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-pulse"></div>
    PROXIMICHAT
  </div>
  <div class="header-right">
    <div class="status-badge" id="hdr-user">
      <div class="dot" id="geo-dot"></div>
      <span id="hdr-user-label">---</span>
    </div>
    <div class="status-badge">
      <div class="dot ok" id="net-dot"></div>
      <span id="msg-count-label">0 MSG</span>
    </div>
    <button class="icon-btn" onclick="toggleConfig()" title="Configure Form Fields">âš™</button>
  </div>
</header>

<!-- MAIN -->
<div class="main">
  <!-- STATUS BAR -->
  <div class="status-bar">
    <div class="sb-item">LAT <span class="sb-val" id="sb-lat">--</span></div>
    <div class="sb-item">LNG <span class="sb-val" id="sb-lng">--</span></div>
    <div class="sb-item">ACC <span class="sb-val" id="sb-acc">-- m</span></div>
    <div class="sb-item">RADIUS <span class="sb-val">20 m</span></div>
    <div class="sb-item">SCAN <span class="sb-val" id="sb-scan">--</span></div>
    <div class="sb-item">VISIBLE <span class="sb-val" id="sb-visible">0</span></div>
  </div>

  <!-- MESSAGES -->
  <div id="messages">
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">ğŸ“¡</div>
      <div>SCANNING FOR NEARBY SIGNALS...</div>
    </div>
  </div>

  <!-- INPUT AREA -->
  <div class="input-area">
    <div class="input-row">
      <textarea id="msg-input" placeholder="Transmit message..." rows="1"
        onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button id="send-btn" onclick="sendMessage()">
        <span id="send-label">SEND â–¸</span>
      </button>
    </div>
    <div class="input-footer">
      <div class="scan-indicator">
        <div class="scan-dot"></div>
        <span id="last-scan-label">LAST SCAN: --</span>
      </div>
      <span>Enter â†µ to send Â· Shift+Enter for newline</span>
    </div>
  </div>
</div>

<!-- CONFIG MODAL -->
<div id="config-modal">
  <div class="config-card">
    <h3>âš™ FORM FIELD CONFIGURATION</h3>
    <p style="font-size:0.72rem;color:var(--text-dim);margin-bottom:16px;font-family:'Share Tech Mono',monospace;">
      Map Google Form entry IDs to data fields. Find these in your form URL or source.
    </p>
    <div class="config-grid">
      <div class="config-row full">
        <label>FORM ACTION URL</label>
        <input id="cfg-form-url" type="text" placeholder="https://docs.google.com/forms/d/e/.../formResponse" />
      </div>
      <div class="config-row full">
        <label>SHEET CSV URL</label>
        <input id="cfg-sheet-url" type="text" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv" />
      </div>
      <div class="config-row">
        <label>ENTRY: MESSAGE</label>
        <input id="cfg-entry-msg" type="text" placeholder="entry.XXXXXXXX" />
      </div>
      <div class="config-row">
        <label>ENTRY: USERNAME</label>
        <input id="cfg-entry-user" type="text" placeholder="entry.XXXXXXXX" />
      </div>
      <div class="config-row">
        <label>ENTRY: LATITUDE</label>
        <input id="cfg-entry-lat" type="text" placeholder="entry.XXXXXXXX" />
      </div>
      <div class="config-row">
        <label>ENTRY: LONGITUDE</label>
        <input id="cfg-entry-lng" type="text" placeholder="entry.XXXXXXXX" />
      </div>
      <div class="config-row">
        <label>SHEET COL: TIMESTAMP</label>
        <input id="cfg-col-ts" type="text" placeholder="0" />
      </div>
      <div class="config-row">
        <label>SHEET COL: MESSAGE</label>
        <input id="cfg-col-msg" type="text" placeholder="1" />
      </div>
      <div class="config-row">
        <label>SHEET COL: USERNAME</label>
        <input id="cfg-col-user" type="text" placeholder="2" />
      </div>
      <div class="config-row">
        <label>SHEET COL: LATITUDE</label>
        <input id="cfg-col-lat" type="text" placeholder="3" />
      </div>
      <div class="config-row full">
        <label>SHEET COL: LONGITUDE</label>
        <input id="cfg-col-lng" type="text" placeholder="4" />
      </div>
      <div class="config-row full">
        <label>POLL INTERVAL (seconds)</label>
        <input id="cfg-poll" type="number" placeholder="5" min="3" max="60" />
      </div>
    </div>
    <div class="config-actions">
      <button class="btn-sm secondary" onclick="toggleConfig()">CANCEL</button>
      <button class="btn-sm primary" onclick="saveConfig()">SAVE CONFIG â–¸</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULT CONFIGURATION
//  Edit these to match your Google Form entry IDs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULTS = {
  formUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSfZReeVsl_qDpTWxBQtvIpkaFTXj9xkfiHU_TmBqghw3unoPg/formResponse',
  sheetCsvUrl: 'https://docs.google.com/spreadsheets/d/1RpumeyOegHo7VDN3fhqVp3USbbb2mGcpmg94OXu6ko0/export?format=csv&gid=0',
  entries: {
    message:   'entry.47638508',   // â† known from your URL
    username:  'entry.UNKNOWN_1',  // â† open form in browser â†’ right-click â†’ Inspect â†’ find entry IDs
    latitude:  'entry.UNKNOWN_2',  // â† OR pre-fill form URL to discover
    longitude: 'entry.UNKNOWN_3',  // â† set these via âš™ button above
  },
  cols: {
    timestamp: 0,
    message:   1,
    username:  2,
    latitude:  3,
    longitude: 4,
  },
  pollInterval: 5 // seconds
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cfg = loadConfig();
let state = {
  username: '',
  lat: null,
  lng: null,
  accuracy: null,
  messages: [],        // all fetched rows
  visibleIds: new Set(),
  pollTimer: null,
  sending: false,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadConfig() {
  try {
    const saved = JSON.parse(localStorage.getItem('proximichat_cfg') || '{}');
    return deepMerge(JSON.parse(JSON.stringify(DEFAULTS)), saved);
  } catch(e) { return JSON.parse(JSON.stringify(DEFAULTS)); }
}

function deepMerge(target, source) {
  for (const key of Object.keys(source)) {
    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
      if (!target[key]) target[key] = {};
      deepMerge(target[key], source[key]);
    } else {
      target[key] = source[key];
    }
  }
  return target;
}

function saveConfig() {
  cfg.formUrl           = document.getElementById('cfg-form-url').value.trim();
  cfg.sheetCsvUrl       = document.getElementById('cfg-sheet-url').value.trim();
  cfg.entries.message   = document.getElementById('cfg-entry-msg').value.trim();
  cfg.entries.username  = document.getElementById('cfg-entry-user').value.trim();
  cfg.entries.latitude  = document.getElementById('cfg-entry-lat').value.trim();
  cfg.entries.longitude = document.getElementById('cfg-entry-lng').value.trim();
  cfg.cols.timestamp    = parseInt(document.getElementById('cfg-col-ts').value) || 0;
  cfg.cols.message      = parseInt(document.getElementById('cfg-col-msg').value) || 1;
  cfg.cols.username     = parseInt(document.getElementById('cfg-col-user').value) || 2;
  cfg.cols.latitude     = parseInt(document.getElementById('cfg-col-lat').value) || 3;
  cfg.cols.longitude    = parseInt(document.getElementById('cfg-col-lng').value) || 4;
  cfg.pollInterval      = parseInt(document.getElementById('cfg-poll').value) || 5;

  try { localStorage.setItem('proximichat_cfg', JSON.stringify(cfg)); } catch(e) {}
  toggleConfig();
  showToast('Configuration saved', 'success');
  restartPoll();
}

function toggleConfig() {
  const modal = document.getElementById('config-modal');
  modal.classList.toggle('open');
  if (modal.classList.contains('open')) {
    // Populate fields
    document.getElementById('cfg-form-url').value   = cfg.formUrl;
    document.getElementById('cfg-sheet-url').value  = cfg.sheetCsvUrl;
    document.getElementById('cfg-entry-msg').value  = cfg.entries.message;
    document.getElementById('cfg-entry-user').value = cfg.entries.username;
    document.getElementById('cfg-entry-lat').value  = cfg.entries.latitude;
    document.getElementById('cfg-entry-lng').value  = cfg.entries.longitude;
    document.getElementById('cfg-col-ts').value     = cfg.cols.timestamp;
    document.getElementById('cfg-col-msg').value    = cfg.cols.message;
    document.getElementById('cfg-col-user').value   = cfg.cols.username;
    document.getElementById('cfg-col-lat').value    = cfg.cols.latitude;
    document.getElementById('cfg-col-lng').value    = cfg.cols.longitude;
    document.getElementById('cfg-poll').value       = cfg.pollInterval;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSession() {
  const username = document.getElementById('setup-username').value.trim();
  if (!username) { showToast('Enter a call sign', 'error'); return; }

  const btn = document.getElementById('setup-btn');
  btn.disabled = true;
  btn.textContent = 'ACQUIRING POSITION...';
  document.getElementById('geo-status').textContent = 'Requesting GPS lock...';

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      state.username = username;
      state.lat      = pos.coords.latitude;
      state.lng      = pos.coords.longitude;
      state.accuracy = pos.coords.accuracy;

      document.getElementById('setup-overlay').style.display = 'none';
      document.getElementById('hdr-user-label').textContent = username.toUpperCase();
      updateStatusBar();
      startWatchPosition();
      startPoll();
      showToast(`Signal acquired â€” ${username}`, 'success');
    },
    (err) => {
      btn.disabled = false;
      btn.textContent = 'ACQUIRE SIGNAL & ENTER';
      const msgs = {
        1: 'Location access denied. Enable in browser settings.',
        2: 'Location unavailable. Try again.',
        3: 'Location timed out. Try again.',
      };
      document.getElementById('geo-status').textContent = msgs[err.code] || 'Location error.';
      showToast('GPS error: ' + (msgs[err.code] || err.message), 'error');
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEOLOCATION WATCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startWatchPosition() {
  navigator.geolocation.watchPosition(
    (pos) => {
      state.lat      = pos.coords.latitude;
      state.lng      = pos.coords.longitude;
      state.accuracy = pos.coords.accuracy;
      updateStatusBar();
      renderMessages(); // re-filter on position change

      const dot = document.getElementById('geo-dot');
      dot.className = 'dot ok';
    },
    (err) => {
      console.warn('Watch position error:', err);
      document.getElementById('geo-dot').className = 'dot warn';
    },
    { enableHighAccuracy: true, maximumAge: 5000 }
  );
}

function updateStatusBar() {
  const fmt = (n, d) => n !== null ? n.toFixed(d) : '--';
  document.getElementById('sb-lat').textContent = fmt(state.lat, 6);
  document.getElementById('sb-lng').textContent = fmt(state.lng, 6);
  document.getElementById('sb-acc').textContent = state.accuracy ? Math.round(state.accuracy) + ' m' : '-- m';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HAVERSINE DISTANCE (meters)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haversine(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV PARSING (handles quoted fields)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCSV(text) {
  const rows = [];
  const lines = text.split('\n');
  for (const line of lines) {
    if (!line.trim()) continue;
    const cells = [];
    let cur = '';
    let inQ = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') {
        if (inQ && line[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (c === ',' && !inQ) {
        cells.push(cur); cur = '';
      } else cur += c;
    }
    cells.push(cur);
    rows.push(cells);
  }
  return rows;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POLL GOOGLE SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchMessages() {
  try {
    const url = cfg.sheetCsvUrl + '&cachebust=' + Date.now();
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);

    // Skip header row
    const dataRows = rows.slice(1);
    const c = cfg.cols;

    state.messages = dataRows.map((row, i) => ({
      id:        i + '_' + (row[c.timestamp] || i),
      timestamp: row[c.timestamp] || '',
      message:   row[c.message]   || '',
      username:  row[c.username]  || '',
      lat:       parseFloat(row[c.latitude]) || null,
      lng:       parseFloat(row[c.longitude]) || null,
    })).filter(m => m.message.trim());

    document.getElementById('sb-scan').textContent = new Date().toLocaleTimeString();
    document.getElementById('last-scan-label').textContent =
      'LAST SCAN: ' + new Date().toLocaleTimeString();

    document.getElementById('net-dot').className = 'dot ok';
    renderMessages();
  } catch(e) {
    console.error('Fetch error:', e);
    document.getElementById('net-dot').className = 'dot warn';
    document.getElementById('sb-scan').textContent = 'ERR';
  }
}

function startPoll() {
  fetchMessages();
  state.pollTimer = setInterval(fetchMessages, cfg.pollInterval * 1000);
}

function restartPoll() {
  if (state.pollTimer) clearInterval(state.pollTimer);
  if (state.username) startPoll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMessages() {
  const container = document.getElementById('messages');
  const emptyState = document.getElementById('empty-state');

  const visible = state.messages.filter(m => isVisible(m));
  document.getElementById('sb-visible').textContent = visible.length;
  document.getElementById('msg-count-label').textContent = visible.length + ' MSG';

  if (visible.length === 0) {
    emptyState.style.display = 'flex';
    // Remove only message elements
    const msgs = container.querySelectorAll('.msg');
    msgs.forEach(m => m.remove());
    return;
  }

  emptyState.style.display = 'none';

  const existingIds = new Set(
    [...container.querySelectorAll('.msg')].map(el => el.dataset.id)
  );

  // Add new messages
  let addedAny = false;
  for (const msg of visible) {
    const id = String(msg.id);
    if (!existingIds.has(id)) {
      const el = createMsgEl(msg);
      container.appendChild(el);
      addedAny = true;
    }
  }

  // Remove messages no longer visible
  const visibleIds = new Set(visible.map(m => String(m.id)));
  for (const el of container.querySelectorAll('.msg')) {
    if (!visibleIds.has(el.dataset.id)) el.remove();
  }

  if (addedAny) {
    container.scrollTop = container.scrollHeight;
  }
}

function isVisible(msg) {
  const isMe = msg.username.toLowerCase().trim() === state.username.toLowerCase().trim();
  if (isMe) return true;

  if (state.lat !== null && state.lng !== null && msg.lat && msg.lng) {
    const dist = haversine(state.lat, state.lng, msg.lat, msg.lng);
    if (dist <= 20) return true;
  }

  return false;
}

function getDistance(msg) {
  if (state.lat !== null && state.lng !== null && msg.lat && msg.lng) {
    return haversine(state.lat, state.lng, msg.lat, msg.lng);
  }
  return null;
}

function createMsgEl(msg) {
  const isMe = msg.username.toLowerCase().trim() === state.username.toLowerCase().trim();
  const dist = getDistance(msg);

  const el = document.createElement('div');
  el.className = 'msg ' + (isMe ? 'mine' : 'other');
  el.dataset.id = String(msg.id);

  const time = formatTime(msg.timestamp);
  const distStr = dist !== null ? Math.round(dist) + 'm' : '';

  el.innerHTML = `
    <div class="msg-meta">
      <span class="msg-user">${escHtml(msg.username || 'UNKNOWN')}</span>
      <span class="msg-time">${time}</span>
      ${distStr ? `<span class="msg-dist">${distStr}</span>` : ''}
      ${isMe ? '<span class="msg-dist" style="border-color:var(--accent);color:var(--accent)">YOU</span>' : ''}
    </div>
    <div class="msg-bubble">${escHtml(msg.message)}</div>
  `;
  return el;
}

function formatTime(ts) {
  if (!ts) return '--:--';
  try {
    const d = new Date(ts);
    if (isNaN(d)) return ts.slice(0, 16);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  } catch(e) { return ts.slice(0, 16); }
}

function escHtml(s) {
  return String(s)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/\n/g, '<br>');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND MESSAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text || state.sending) return;
  if (!state.lat || !state.lng) {
    showToast('GPS not ready. Wait for location lock.', 'error');
    return;
  }

  state.sending = true;
  const btn = document.getElementById('send-btn');
  btn.disabled = true;
  document.getElementById('send-label').innerHTML = '<span class="sending-spinner"></span> SENDING';

  const params = new URLSearchParams();
  params.append(cfg.entries.message,   text);
  params.append(cfg.entries.username,  state.username);
  params.append(cfg.entries.latitude,  state.lat.toFixed(8));
  params.append(cfg.entries.longitude, state.lng.toFixed(8));

  try {
    await fetch(cfg.formUrl, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params.toString()
    });

    input.value = '';
    input.style.height = '';
    showToast('Transmitted', 'success');

    // Poll immediately for fast feedback
    setTimeout(fetchMessages, 1500);
    setTimeout(fetchMessages, 4000);
  } catch(e) {
    showToast('Send failed: ' + e.message, 'error');
  } finally {
    state.sending = false;
    btn.disabled = false;
    document.getElementById('send-label').textContent = 'SEND â–¸';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = '';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

let toastTimer;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.className = ''; }, 3000);
}

// Kick off geo status polling
setInterval(() => {
  const dot = document.getElementById('geo-dot');
  if (state.lat !== null) dot.className = 'dot ok';
}, 2000);

// Hint in setup box
document.getElementById('setup-username').addEventListener('keydown', e => {
  if (e.key === 'Enter') startSession();
});

window.addEventListener('load', () => {
  document.getElementById('geo-status').textContent = 'Enter a call sign and click Enter to get started';
});
</script>
</body>
</html>
