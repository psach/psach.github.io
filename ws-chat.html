<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WS://CHAT — WebSocket Terminal</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:       #080b08;
    --surface:  #0d120d;
    --border:   #1a2e1a;
    --green:    #39ff14;
    --green-dim:#1a7a08;
    --amber:    #ffb700;
    --red:      #ff3b3b;
    --text:     #b8d4b8;
    --text-dim: #3d5c3d;
    --glow:     0 0 12px rgba(57,255,20,0.25);
    --glow-lg:  0 0 40px rgba(57,255,20,0.15);
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    overflow: hidden;
  }

  /* CRT scanlines overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  /* CRT vignette */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.7) 100%);
    pointer-events: none;
    z-index: 9998;
  }

  /* ── LAYOUT ── */
  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-width: 900px;
    margin: 0 auto;
    padding: 0 12px;
  }

  /* ── HEADER ── */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 0 12px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-weight: 900;
    font-size: 18px;
    color: var(--green);
    text-shadow: var(--glow);
    letter-spacing: 0.05em;
  }
  .logo span { color: var(--amber); }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  #username-display {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  #username-display strong {
    color: var(--amber);
  }

  /* ── STATUS BAR ── */
  .status-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 11px;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--red);
    flex-shrink: 0;
    transition: background 0.3s, box-shadow 0.3s;
  }
  .status-dot.connected {
    background: var(--green);
    box-shadow: 0 0 8px rgba(57,255,20,0.8);
    animation: pulse 2s infinite;
  }
  .status-dot.connecting {
    background: var(--amber);
    box-shadow: 0 0 8px rgba(255,183,0,0.8);
    animation: blink 0.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.2; }
  }

  #status-text { flex: 1; }

  .server-url {
    color: var(--green-dim);
    font-size: 10px;
    max-width: 320px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* ── CONNECT PANEL ── */
  #connect-panel {
    display: flex;
    gap: 8px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    flex-wrap: wrap;
  }

  .field-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .field-group label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-dim);
  }

  input[type="text"] {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    padding: 7px 10px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  input[type="text"]:focus {
    border-color: var(--green-dim);
    box-shadow: 0 0 0 1px var(--green-dim);
  }
  input[type="text"]::placeholder { color: var(--text-dim); }

  #url-input { width: 300px; font-size: 11px; }
  #user-input { width: 140px; }

  .btn {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 7px 16px;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.15s;
    align-self: flex-end;
  }

  #connect-btn {
    background: transparent;
    border-color: var(--green);
    color: var(--green);
  }
  #connect-btn:hover {
    background: var(--green);
    color: var(--bg);
    box-shadow: var(--glow);
  }
  #connect-btn.disconnect {
    border-color: var(--red);
    color: var(--red);
  }
  #connect-btn.disconnect:hover {
    background: var(--red);
    color: var(--bg);
    box-shadow: 0 0 12px rgba(255,59,59,0.4);
  }

  /* ── MESSAGES ── */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  #messages::-webkit-scrollbar { width: 4px; }
  #messages::-webkit-scrollbar-track { background: transparent; }
  #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg {
    display: flex;
    gap: 12px;
    padding: 5px 8px;
    font-size: 13px;
    line-height: 1.5;
    transition: background 0.1s;
    animation: msgIn 0.15s ease-out;
  }
  .msg:hover { background: rgba(255,255,255,0.02); }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(4px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .msg-time {
    color: var(--text-dim);
    font-size: 10px;
    flex-shrink: 0;
    padding-top: 2px;
    min-width: 48px;
    text-align: right;
  }

  .msg-author {
    font-weight: 700;
    flex-shrink: 0;
    min-width: 90px;
    text-align: right;
    padding-top: 1px;
  }

  .msg-body { color: var(--text); word-break: break-word; }

  .msg.sent   .msg-author { color: var(--amber); }
  .msg.received .msg-author { color: var(--green); }
  .msg.system { opacity: 0.6; }
  .msg.system .msg-author { color: var(--text-dim); }
  .msg.system .msg-body { color: var(--text-dim); font-style: italic; }
  .msg.error .msg-author { color: var(--red); }
  .msg.error .msg-body { color: var(--red); opacity: 0.8; }

  .msg-prefix {
    color: var(--text-dim);
    font-size: 10px;
    padding-top: 2px;
    flex-shrink: 0;
  }

  /* ── INPUT AREA ── */
  #input-area {
    border-top: 1px solid var(--border);
    padding: 12px 0 16px;
    flex-shrink: 0;
  }

  .input-row {
    display: flex;
    align-items: center;
    gap: 0;
  }

  .prompt-symbol {
    color: var(--green);
    font-size: 16px;
    font-weight: 700;
    padding: 10px 10px 10px 4px;
    flex-shrink: 0;
    text-shadow: var(--glow);
  }

  #msg-input {
    flex: 1;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    padding: 10px 8px;
    outline: none;
    transition: border-color 0.2s;
  }
  #msg-input:focus {
    border-bottom-color: var(--green);
  }
  #msg-input:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  #send-btn {
    background: transparent;
    border: 1px solid var(--green-dim);
    border-left: none;
    color: var(--green-dim);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    padding: 11px 16px;
    cursor: pointer;
    transition: all 0.15s;
  }
  #send-btn:hover:not(:disabled) {
    background: var(--green);
    border-color: var(--green);
    color: var(--bg);
    box-shadow: var(--glow);
  }
  #send-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .input-hint {
    margin-top: 6px;
    font-size: 10px;
    color: var(--text-dim);
    padding-left: 28px;
    letter-spacing: 0.05em;
  }

  /* ── EMPTY STATE ── */
  #empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--text-dim);
  }
  .empty-art {
    font-size: 11px;
    line-height: 1.4;
    color: var(--green-dim);
    text-align: center;
    opacity: 0.7;
  }
  .empty-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
  }

  /* ── STATS ── */
  .stats {
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    gap: 16px;
    padding: 4px 0 0;
    letter-spacing: 0.06em;
  }
  .stats span { color: var(--green-dim); }
</style>
</head>
<body>
<div id="app">

  <!-- HEADER -->
  <header>
    <div class="logo">WS<span>://</span>CHAT</div>
    <div class="header-right">
      <div id="username-display">user: <strong id="uname-label">—</strong></div>
    </div>
  </header>

  <!-- STATUS -->
  <div class="status-bar">
    <div class="status-dot" id="status-dot"></div>
    <div id="status-text">DISCONNECTED</div>
    <div class="server-url" id="server-url-label"></div>
  </div>

  <!-- CONNECT PANEL -->
  <div id="connect-panel">
    <div class="field-group">
      <label>WebSocket Server URL</label>
      <input id="url-input" type="text" value="wss://echo.websocket.org" placeholder="wss://...">
    </div>
    <div class="field-group">
      <label>Your Username</label>
      <input id="user-input" type="text" placeholder="anonymous" maxlength="20">
    </div>
    <button class="btn" id="connect-btn" onclick="toggleConnection()">Connect</button>
  </div>

  <!-- MESSAGES -->
  <div id="messages">
    <div id="empty-state">
      <div class="empty-art">
┌─────────────────────────────┐<br>
│  WebSocket Terminal v2.0    │<br>
│  echo.websocket.org ready   │<br>
└─────────────────────────────┘
      </div>
      <div class="empty-label">Connect to start chatting</div>
      <div style="font-size:11px; color: var(--text-dim); max-width: 360px; text-align:center; line-height:1.7;">
        Uses the <span style="color:var(--green-dim)">websocket.org</span> echo server by default.
        Messages you send will be echoed back. Connect to any WebSocket endpoint.
      </div>
    </div>
  </div>

  <!-- INPUT -->
  <div id="input-area">
    <div class="input-row">
      <div class="prompt-symbol">❯</div>
      <input id="msg-input" type="text" placeholder="Type a message…" disabled
             onkeydown="if(event.key==='Enter') sendMessage()">
      <button id="send-btn" disabled onclick="sendMessage()">Send</button>
    </div>
    <div class="stats">
      Sent: <span id="s-sent">0</span> &nbsp;|&nbsp; Received: <span id="s-recv">0</span> &nbsp;|&nbsp; Latency: <span id="s-lat">—</span>ms
    </div>
  </div>

</div>

<script>
  let ws = null;
  let connected = false;
  let sentCount = 0, recvCount = 0;
  let pingTime = 0;
  let latencyInterval = null;

  const dot       = document.getElementById('status-dot');
  const statusTxt = document.getElementById('status-text');
  const serverLbl = document.getElementById('server-url-label');
  const msgBox    = document.getElementById('messages');
  const msgInput  = document.getElementById('msg-input');
  const sendBtn   = document.getElementById('send-btn');
  const connectBtn= document.getElementById('connect-btn');
  const emptyState= document.getElementById('empty-state');
  const urlInput  = document.getElementById('url-input');
  const userInput = document.getElementById('user-input');
  const unameLabel= document.getElementById('uname-label');
  const sSent     = document.getElementById('s-sent');
  const sRecv     = document.getElementById('s-recv');
  const sLat      = document.getElementById('s-lat');

  function getUsername() {
    return userInput.value.trim() || 'anonymous';
  }

  function setStatus(state) {
    dot.className = 'status-dot ' + state;
    if (state === 'connected') {
      statusTxt.textContent = 'CONNECTED';
      statusTxt.style.color = 'var(--green)';
    } else if (state === 'connecting') {
      statusTxt.textContent = 'CONNECTING…';
      statusTxt.style.color = 'var(--amber)';
    } else {
      statusTxt.textContent = 'DISCONNECTED';
      statusTxt.style.color = '';
    }
  }

  function addMessage(type, author, body, prefix='') {
    if (emptyState.parentNode === msgBox) {
      msgBox.removeChild(emptyState);
    }
    const now = new Date();
    const time = now.toTimeString().slice(0,8);

    const el = document.createElement('div');
    el.className = 'msg ' + type;
    el.innerHTML = `
      <div class="msg-time">${time}</div>
      <div class="msg-prefix">${prefix}</div>
      <div class="msg-author">${escHtml(author)}</div>
      <div class="msg-body">${escHtml(body)}</div>
    `;
    msgBox.appendChild(el);
    msgBox.scrollTop = msgBox.scrollHeight;
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function toggleConnection() {
    if (connected || ws) {
      disconnect();
    } else {
      connect();
    }
  }

  function connect() {
    const url = urlInput.value.trim();
    if (!url) return;

    setStatus('connecting');
    connectBtn.textContent = 'Cancel';
    connectBtn.className = 'btn disconnect';
    serverLbl.textContent = url;
    unameLabel.textContent = getUsername();
    urlInput.disabled = true;
    userInput.disabled = true;

    try {
      ws = new WebSocket(url);
    } catch(e) {
      setStatus('');
      addMessage('error', 'SYS', 'Invalid URL: ' + e.message);
      resetUI();
      return;
    }

    ws.onopen = () => {
      connected = true;
      setStatus('connected');
      connectBtn.textContent = 'Disconnect';
      connectBtn.className = 'btn disconnect';
      msgInput.disabled = false;
      sendBtn.disabled = false;
      msgInput.focus();
      addMessage('system', 'SYS', `Connected to ${url}`);
      startLatencyPing();
    };

    ws.onmessage = (e) => {
      recvCount++;
      sRecv.textContent = recvCount;

      // Check if it's our own latency ping
      if (e.data && e.data.startsWith('__ping__')) {
        const t = parseInt(e.data.split(':')[1]);
        if (!isNaN(t)) {
          const lat = Date.now() - t;
          sLat.textContent = lat;
        }
        return;
      }

      // Try to parse as JSON (if we sent JSON)
      let author = 'ECHO', body = e.data;
      try {
        const parsed = JSON.parse(e.data);
        if (parsed.user && parsed.msg) {
          author = parsed.user;
          body = parsed.msg;
        }
      } catch(_) {}

      // If this is echo of our own message, label it as echo
      if (author === getUsername()) {
        addMessage('received', '⟲ ECHO', body, '←');
      } else {
        addMessage('received', author, body, '←');
      }
    };

    ws.onerror = () => {
      addMessage('error', 'SYS', 'WebSocket error occurred. Check the URL and try again.');
    };

    ws.onclose = (e) => {
      connected = false;
      ws = null;
      stopLatencyPing();
      setStatus('');
      msgInput.disabled = true;
      sendBtn.disabled = true;
      addMessage('system', 'SYS', `Disconnected (code ${e.code}${e.reason ? ': ' + e.reason : ''})`);
      resetUI();
    };
  }

  function disconnect() {
    if (ws) ws.close();
  }

  function resetUI() {
    connectBtn.textContent = 'Connect';
    connectBtn.className = 'btn';
    urlInput.disabled = false;
    userInput.disabled = false;
    serverLbl.textContent = '';
  }

  function sendMessage() {
    const text = msgInput.value.trim();
    if (!text || !connected || !ws) return;

    const payload = JSON.stringify({ user: getUsername(), msg: text });
    ws.send(payload);

    sentCount++;
    sSent.textContent = sentCount;
    addMessage('sent', getUsername(), text, '→');
    msgInput.value = '';
  }

  function startLatencyPing() {
    stopLatencyPing();
    latencyInterval = setInterval(() => {
      if (connected && ws && ws.readyState === WebSocket.OPEN) {
        pingTime = Date.now();
        ws.send('__ping__:' + pingTime);
      }
    }, 3000);
  }

  function stopLatencyPing() {
    if (latencyInterval) { clearInterval(latencyInterval); latencyInterval = null; }
    sLat.textContent = '—';
  }

  // Enter to connect from URL input
  urlInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !connected) connect();
  });
  userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !connected) connect();
  });
</script>
</body>
</html>
