<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Alerting System</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS for Mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Ensure map takes up proper space */
        #map { height: 100%; width: 100%; border-radius: 0.5rem; z-index: 10; }
        .hidden-view { display: none !important; }
        
        /* Custom scrollbar for chat */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .pulse-red {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col font-sans overflow-hidden">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="absolute inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 text-red-600 mb-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Emergency System</h1>
                <p class="text-sm text-slate-500 mt-2">Join a group to share location and alerts.</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                    <input type="text" id="input-username" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="E.g., John Doe" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Group Code</label>
                    <input type="text" id="input-groupcode" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all uppercase" placeholder="E.g., ALPHA-99" required>
                </div>
                
                <div id="setup-error" class="hidden text-red-500 text-sm text-center">Please fill in all fields.</div>
                
                <button onclick="joinGroup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors flex justify-center items-center gap-2">
                    Join / Create Group
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="main-app" class="hidden h-full flex flex-col max-w-4xl mx-auto w-full bg-white shadow-xl relative">
        
        <!-- Header -->
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center z-20 shadow-md">
            <div>
                <h2 class="font-bold text-lg leading-tight">Emergency Comms</h2>
                <div class="text-xs text-slate-300 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-400"></span>
                    Group: <span id="display-groupcode" class="font-mono font-bold text-yellow-300">---</span>
                </div>
            </div>
            
            <!-- View Toggles -->
            <div class="flex bg-slate-800 rounded-lg p-1">
                <button onclick="toggleView('list')" id="btn-list-view" class="px-4 py-1.5 rounded-md text-sm font-medium bg-slate-600 shadow-sm transition-all">List</button>
                <button onclick="toggleView('map')" id="btn-map-view" class="px-4 py-1.5 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-all">Map</button>
            </div>
        </header>

        <!-- Notification Banner -->
        <div id="notification-banner" class="hidden bg-red-600 text-white text-center py-2 text-sm font-bold flex justify-center items-center gap-2 animate-pulse z-20">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            NEW EMERGENCY ALERT
        </div>

        <!-- Content Area -->
        <div class="flex-1 relative overflow-hidden bg-slate-50">
            
            <!-- List View -->
            <div id="view-list" class="absolute inset-0 p-4 overflow-y-auto flex flex-col gap-3">
                <div class="text-center text-xs text-slate-400 my-2">System Initialized. Awaiting messages...</div>
                <!-- Messages will be injected here -->
                <div id="message-container" class="flex flex-col gap-3 pb-20"></div>
            </div>

            <!-- Map View -->
            <div id="view-map" class="absolute inset-0 hidden-view p-2 bg-slate-200">
                <div id="map" class="shadow-inner border border-slate-300"></div>
            </div>
            
        </div>

        <!-- Input Area -->
        <div class="bg-white border-t border-slate-200 p-4 z-20 pb-safe">
            <div id="location-status" class="text-xs text-slate-500 mb-2 flex justify-between items-center">
                <span>üìç Getting location...</span>
            </div>
            <div class="flex gap-2">
                <input type="text" id="input-message" class="flex-1 bg-slate-100 border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type a message...">
                
                <button onclick="sendMessage('Chat')" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 font-medium transition-colors">
                    Send
                </button>
                
                <button onclick="sendMessage('Alert')" class="bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 font-bold transition-colors pulse-red whitespace-nowrap flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    ALERT
                </button>
            </div>
        </div>
        
    </div>

    <!-- Hidden iframe for silent Google Form submissions -->
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <script>
        /* =========================================================================
           CONFIGURATION (Google Forms & Sheets)
           ========================================================================= */
        
        // SET THIS TO FALSE to use your actual Google Forms/Sheets.
        // If TRUE, it will mock the database locally so you can test the UI instantly.
        const MOCK_MODE = true; 

        const GOOGLE_CONFIG = {
            // Write: Google Form URL (Change to your form's formResponse URL)
            FORM_URL: "https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse",
            
            // Read: Google Sheet Published CSV URL (File -> Share -> Publish to Web -> CSV)
            SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/YOUR_SHEET_ID/pub?output=csv",
            
            // Google Form Entry IDs (Inspect your form to find these numbers)
            ENTRIES: {
                TIMESTAMP: "entry.111111111",
                GROUP_CODE: "entry.222222222",
                USERNAME: "entry.333333333",
                LAT: "entry.444444444",
                LNG: "entry.555555555",
                MESSAGE: "entry.666666666",
                TYPE: "entry.777777777" // 'Chat' or 'Alert'
            }
        };

        const POLL_INTERVAL_MS = 3000; // Poll every 3 seconds

        /* =========================================================================
           STATE MANAGEMENT
           ========================================================================= */
        let state = {
            username: '',
            groupCode: '',
            lat: null,
            lng: null,
            messages: [],
            lastMessageCount: 0,
            mapInitialized: false,
            pollTimer: null
        };

        let map = null;
        let markers = {}; 
        let submitted = false; 
        let mockDatabase = []; 

        /* Attach iframe onload listener here to avoid the ReferenceError */
        document.getElementById('hidden_iframe').onload = function() {
            if (submitted) {
                onFormSubmitted();
            }
        };

        /* =========================================================================
           INITIALIZATION & AUTH
           ========================================================================= */
        function joinGroup() {
            const user = document.getElementById('input-username').value.trim();
            const group = document.getElementById('input-groupcode').value.trim().toUpperCase();
            
            if (!user || !group) {
                document.getElementById('setup-error').classList.remove('hidden');
                return;
            }

            state.username = user;
            state.groupCode = group;
            
            // Update UI
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('display-groupcode').innerText = state.groupCode;

            // Start background processes
            initGeolocation();
            startPolling();
        }

        /* =========================================================================
           GEOLOCATION
           ========================================================================= */
        function initGeolocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        state.lat = position.coords.latitude;
                        state.lng = position.coords.longitude;
                        document.getElementById('location-status').innerHTML = `
                            <span class="text-green-600 font-medium">üìç Location Active (${state.lat.toFixed(4)}, ${state.lng.toFixed(4)})</span>
                        `;
                        // Update map center if we are the only one on it currently
                        if(map && Object.keys(markers).length === 0) {
                            map.setView([state.lat, state.lng], 15);
                        }
                    },
                    (error) => {
                        console.error("Location error:", error);
                        document.getElementById('location-status').innerHTML = `
                            <span class="text-red-500 font-medium">‚ö†Ô∏è Location Access Denied. Cannot send coordinates.</span>
                        `;
                    },
                    { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
                );
            } else {
                document.getElementById('location-status').innerText = "Geolocation not supported by this browser.";
            }
        }

        /* =========================================================================
           UI TOGGLES
           ========================================================================= */
        function toggleView(view) {
            const listView = document.getElementById('view-list');
            const mapView = document.getElementById('view-map');
            const btnList = document.getElementById('btn-list-view');
            const btnMap = document.getElementById('btn-map-view');

            if (view === 'list') {
                listView.classList.remove('hidden-view');
                mapView.classList.add('hidden-view');
                
                btnList.classList.replace('bg-transparent', 'bg-slate-600');
                btnList.classList.replace('text-slate-400', 'text-white');
                btnMap.classList.replace('bg-slate-600', 'bg-transparent');
                btnMap.classList.replace('text-white', 'text-slate-400');
            } else {
                listView.classList.add('hidden-view');
                mapView.classList.remove('hidden-view');
                
                btnMap.classList.replace('bg-transparent', 'bg-slate-600');
                btnMap.classList.replace('text-slate-400', 'text-white');
                btnList.classList.replace('bg-slate-600', 'bg-transparent');
                btnList.classList.replace('text-white', 'text-slate-400');

                // Initialize Leaflet map only when view is first opened
                if (!state.mapInitialized) {
                    initMap();
                } else {
                    map.invalidateSize(); // Fix tile loading issues when unhiding
                }
            }
        }

        /* =========================================================================
           MAP INITIALIZATION (Leaflet.js)
           ========================================================================= */
        function initMap() {
            // Default center (will be updated by geolocation or markers)
            const startLat = state.lat || 0;
            const startLng = state.lng || 0;

            map = L.map('map').setView([startLat, startLng], 13);
            
            // OpenStreetMap tiles (Open Source)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            state.mapInitialized = true;
            renderMapMarkers(); // Render any existing messages onto the map
        }

        /* =========================================================================
           DATA TRANSMISSION (WRITE)
           ========================================================================= */
        function sendMessage(type) {
            const msgInput = document.getElementById('input-message');
            const text = msgInput.value.trim();
            
            if (!text && type === 'Chat') return; // Chat requires text, Alert doesn't strictly need it

            // Optimistic UI Update (Show immediately locally)
            const timestamp = new Date().toISOString();
            const tempMsg = {
                timestamp: timestamp,
                groupCode: state.groupCode,
                username: state.username,
                lat: state.lat || '',
                lng: state.lng || '',
                message: text || (type === 'Alert' ? 'TRIGGERED EMERGENCY ALERT!' : ''),
                type: type
            };
            
            msgInput.value = ''; // clear input

            if (MOCK_MODE) {
                // Simulate backend write
                mockDatabase.push(tempMsg);
                processIncomingData(mockDatabase);
            } else {
                // Actual Google Form Submission via hidden iframe
                submitToGoogleForm(tempMsg);
            }
        }

        function submitToGoogleForm(data) {
            submitted = true; // Set flag so iframe onload triggers success
            
            // Create a temporary form and submit it to the hidden iframe
            const form = document.createElement('form');
            form.action = GOOGLE_CONFIG.FORM_URL;
            form.method = 'POST';
            form.target = 'hidden_iframe';

            const mapData = {
                [GOOGLE_CONFIG.ENTRIES.TIMESTAMP]: data.timestamp,
                [GOOGLE_CONFIG.ENTRIES.GROUP_CODE]: data.groupCode,
                [GOOGLE_CONFIG.ENTRIES.USERNAME]: data.username,
                [GOOGLE_CONFIG.ENTRIES.LAT]: data.lat,
                [GOOGLE_CONFIG.ENTRIES.LNG]: data.lng,
                [GOOGLE_CONFIG.ENTRIES.MESSAGE]: data.message,
                [GOOGLE_CONFIG.ENTRIES.TYPE]: data.type
            };

            for (let key in mapData) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = mapData[key];
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
            
            // Optimistically update UI while waiting for poll to catch up
            state.messages.push(data);
            renderList();
            if(state.mapInitialized) renderMapMarkers();
        }

        function onFormSubmitted() {
            submitted = false;
            // The polling mechanism will automatically grab the new data shortly.
            console.log("Form successfully submitted silently.");
        }

        /* =========================================================================
           DATA RETRIEVAL (READ / POLL)
           ========================================================================= */
        function startPolling() {
            pollData(); // Initial poll
            state.pollTimer = setInterval(pollData, POLL_INTERVAL_MS);
        }

        async function pollData() {
            if (MOCK_MODE) {
                processIncomingData(mockDatabase);
                return;
            }

            try {
                // Fetch the published CSV from Google Sheets
                // We append a random string to bypass browser/CDN caching
                const response = await fetch(`${GOOGLE_CONFIG.SHEET_CSV_URL}&t=${new Date().getTime()}`);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                processIncomingData(parsedData);
                
            } catch (error) {
                console.error("Polling error:", error);
            }
        }

        // Simple CSV parser tailored for Google Sheets output
        function parseCSV(str) {
            const result = [];
            // Regex to handle commas inside quotes
            const lines = str.split('\n');
            if(lines.length < 2) return result;

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            for(let i=1; i<lines.length; i++) {
                if(!lines[i].trim()) continue;
                
                // Split by comma, respecting quotes
                const currentline = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const obj = {};
                
                // Map to our expected keys based on order.
                // Assuming Google sheet columns: Timestamp, GroupCode, Username, Lat, Lng, Message, Type
                obj.timestamp = cleanCSVField(currentline[0]);
                obj.groupCode = cleanCSVField(currentline[1]);
                obj.username = cleanCSVField(currentline[2]);
                obj.lat = cleanCSVField(currentline[3]);
                obj.lng = cleanCSVField(currentline[4]);
                obj.message = cleanCSVField(currentline[5]);
                obj.type = cleanCSVField(currentline[6]);

                result.push(obj);
            }
            return result;
        }

        function cleanCSVField(field) {
            if(!field) return '';
            return field.trim().replace(/^"|"$/g, '');
        }

        function processIncomingData(allData) {
            // 1. Filter data by Group Code
            const groupData = allData.filter(row => 
                row.groupCode && row.groupCode.toUpperCase() === state.groupCode
            );

            // 2. Check for new messages
            if (groupData.length > state.lastMessageCount) {
                
                // Find new alerts specifically to trigger sound
                const newItems = groupData.slice(state.lastMessageCount);
                const hasNewAlert = newItems.some(item => 
                    item.type === 'Alert' && item.username !== state.username
                );

                if (hasNewAlert) {
                    triggerEmergencyAlertUI();
                }

                state.messages = groupData;
                state.lastMessageCount = groupData.length;
                
                // 3. Update Views
                renderList();
                if (state.mapInitialized) {
                    renderMapMarkers();
                }
            }
        }

        /* =========================================================================
           VIEW RENDERING
           ========================================================================= */
        function renderList() {
            const container = document.getElementById('message-container');
            container.innerHTML = ''; // Clear current

            if(state.messages.length === 0) {
                container.innerHTML = '<div class="text-center text-sm text-slate-400">No messages yet.</div>';
                return;
            }

            state.messages.forEach(msg => {
                const isMe = msg.username === state.username;
                const isAlert = msg.type === 'Alert';
                
                const timeStr = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

                const div = document.createElement('div');
                div.className = `flex flex-col max-w-[85%] rounded-xl p-3 shadow-sm ${
                    isAlert 
                        ? 'bg-red-100 border border-red-300 self-center w-full text-center' 
                        : (isMe ? 'bg-blue-600 text-white self-end' : 'bg-white border border-slate-200 self-start text-slate-800')
                }`;

                let content = '';
                
                if (isAlert) {
                    content = `
                        <div class="text-red-700 font-bold uppercase tracking-wide flex items-center justify-center gap-2">
                            ‚ö†Ô∏è Emergency Alert from ${msg.username} ‚ö†Ô∏è
                        </div>
                        ${msg.message ? `<div class="text-red-800 mt-1 font-medium">${msg.message}</div>` : ''}
                        <div class="text-xs text-red-500 mt-2">${timeStr} ${msg.lat ? `| Loc: ${parseFloat(msg.lat).toFixed(4)}, ${parseFloat(msg.lng).toFixed(4)}` : ''}</div>
                    `;
                } else {
                    content = `
                        ${!isMe ? `<div class="text-xs font-bold mb-1 text-slate-500">${msg.username}</div>` : ''}
                        <div class="text-sm">${msg.message}</div>
                        <div class="text-[10px] mt-1 text-right opacity-70 flex justify-between">
                            ${msg.lat ? `<span title="Location attached">üìç</span>` : '<span></span>'}
                            <span>${timeStr}</span>
                        </div>
                    `;
                }

                div.innerHTML = content;
                container.appendChild(div);
            });

            // Auto-scroll to bottom
            const viewList = document.getElementById('view-list');
            viewList.scrollTop = viewList.scrollHeight;
        }

        function renderMapMarkers() {
            if (!map) return;

            // Group messages by user to show latest location per user
            const latestLocations = {};
            
            state.messages.forEach(msg => {
                if (msg.lat && msg.lng && msg.lat !== 'undefined' && msg.lng !== 'undefined') {
                    latestLocations[msg.username] = msg; // Overwrites older msgs from same user
                }
            });

            // Add/Update markers
            Object.values(latestLocations).forEach(msg => {
                const lat = parseFloat(msg.lat);
                const lng = parseFloat(msg.lng);
                
                if (isNaN(lat) || isNaN(lng)) return;

                const isAlert = msg.type === 'Alert';
                const markerId = msg.username;

                // Create custom icon based on type
                const markerColor = isAlert ? '#ef4444' : '#3b82f6'; // Red vs Blue
                const svgIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:${markerColor}; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow:0 0 4px rgba(0,0,0,0.5);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                if (markers[markerId]) {
                    // Update existing marker
                    markers[markerId].setLatLng([lat, lng]);
                    markers[markerId].setIcon(svgIcon);
                    markers[markerId].setPopupContent(`
                        <div class="font-bold">${msg.username}</div>
                        <div class="text-xs">${isAlert ? '<span class="text-red-600 font-bold">EMERGENCY</span>' : 'Latest location'}</div>
                        <div class="text-xs text-gray-500">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                    `);
                } else {
                    // Create new marker
                    const marker = L.marker([lat, lng], {icon: svgIcon}).addTo(map);
                    marker.bindPopup(`
                        <div class="font-bold">${msg.username}</div>
                        <div class="text-xs">${isAlert ? '<span class="text-red-600 font-bold">EMERGENCY</span>' : 'Latest location'}</div>
                        <div class="text-xs text-gray-500">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                    `);
                    markers[markerId] = marker;
                }
            });
            
            // Adjust bounds to fit all markers if there are any
            const markerGroup = L.featureGroup(Object.values(markers));
            if (Object.keys(markers).length > 0) {
                map.fitBounds(markerGroup.getBounds().pad(0.2));
            }
        }

        /* =========================================================================
           EMERGENCY AUDIO & UI ALERTS
           ========================================================================= */
        function triggerEmergencyAlertUI() {
            // Play Sound
            playSiren();

            // Show Banner
            const banner = document.getElementById('notification-banner');
            banner.classList.remove('hidden');
            
            // Auto hide banner after 10 seconds
            setTimeout(() => {
                banner.classList.add('hidden');
            }, 10000);
        }

        // Self-contained synthesizer siren using Web Audio API (No external files needed)
        function playSiren() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gainNode = ctx.createGain();

                osc.connect(gainNode);
                gainNode.connect(ctx.destination);

                osc.type = 'square'; // Harsh sound good for alarms

                // Siren modulation: High to low sweeping
                const now = ctx.currentTime;
                
                // Volume envelope
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.1); // Max volume 30%
                gainNode.gain.setValueAtTime(0.3, now + 2.5);
                gainNode.gain.linearRampToValueAtTime(0, now + 3.0);

                // Frequency modulation loop (European style siren)
                for(let i=0; i<3; i++) {
                    let offset = i * 1.0;
                    osc.frequency.setValueAtTime(800, now + offset);
                    osc.frequency.setValueAtTime(800, now + offset + 0.45);
                    osc.frequency.setValueAtTime(600, now + offset + 0.5);
                    osc.frequency.setValueAtTime(600, now + offset + 0.95);
                }

                osc.start(now);
                osc.stop(now + 3.0);
            } catch(e) {
                console.warn("Audio Context blocked or unsupported. User interaction might be required first.");
            }
        }

    </script>
</body>
</html>